rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isVerifiedSeller() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verifiedSeller == true;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow authenticated users to read any user document
      allow read: if isAuthenticated();
      // Allow users to create their own document or admins to create any
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Allow users to update their own document or admins to update any
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if true; // Public read
      allow create: if isVerifiedSeller();
      allow update: if isVerifiedSeller() && 
                     resource.data.sellerId == request.auth.uid;
      allow delete: if isVerifiedSeller() && 
                     resource.data.sellerId == request.auth.uid || isAdmin();
    }
    
    // Seller requests collection
    match /sellerRequests/{requestId} {
      allow read: if isAdmin();
      allow create: if true; // Allow anyone to create seller requests (guests or authenticated users)
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // User Chats collection - Each user has their own list of chats (Facebook Messenger style)
    // This avoids array-contains security rule issues entirely
    match /userChats/{userId}/chats/{chatRefId} {
      // Helper to check if current user is participant in a chat (for reading/updating other users' references)
      function isParticipantInChatRef() {
        return resource.data.chatId != null &&
               exists(/databases/$(database)/documents/chats/$(resource.data.chatId)) &&
               get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants != null &&
               get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants is list &&
               get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants.size() > 0 &&
               (request.auth.uid == get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants[0] ||
                (get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants.size() > 1 && 
                 request.auth.uid == get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants[1]));
      }
      
      // Users can read their own chat list OR read other users' references if they're a participant
      allow read: if isAuthenticated() && (request.auth.uid == userId || isParticipantInChatRef());
      
      // Users can write their own chat list
      allow write: if isAuthenticated() && request.auth.uid == userId;
      
      // Helper to check if current user is participant in a chat (cached version for create/update)
      function isParticipantInChat(chatIdToCheck) {
        let chatDoc = get(/databases/$(database)/documents/chats/$(chatIdToCheck));
        let participants = chatDoc.data.participants;
        return participants != null && 
               participants is list &&
               participants.size() > 0 &&
               (request.auth.uid == participants[0] ||
                (participants.size() > 1 && request.auth.uid == participants[1]));
      }
      
      // Allow creating chat references for other users if:
      // 1. The chat exists
      // 2. The current user is a participant in that chat
      // 3. The otherUserId in the reference is the current user (we're creating a reference for the other participant pointing back to us)
      allow create: if isAuthenticated() && 
                     request.resource.data.chatId != null &&
                     exists(/databases/$(database)/documents/chats/$(request.resource.data.chatId)) &&
                     isParticipantInChat(request.resource.data.chatId) &&
                     request.resource.data.otherUserId == request.auth.uid;
      
      // Allow updating chat references for other users if:
      // 1. The chat exists and user is a participant
      // 2. Only updating lastMessage and lastMessageTime fields (for message notifications)
      // 3. Not changing critical fields (chatId, otherUserId, productId)
      allow update: if isAuthenticated() &&
                     resource.data.chatId != null &&
                     request.resource.data.chatId != null &&
                     request.resource.data.chatId == resource.data.chatId &&
                     exists(/databases/$(database)/documents/chats/$(resource.data.chatId)) &&
                     isParticipantInChat(resource.data.chatId) &&
                     // Ensure critical fields don't change
                     request.resource.data.otherUserId == resource.data.otherUserId &&
                     (request.resource.data.productId == resource.data.productId ||
                      resource.data.productId == null);
    }
    
    // Chats collection - The actual chat documents
    match /chats/{chatId} {
      // Helper to check if current user is in participants array (for individual gets)
      function userIsParticipant() {
        return resource.data != null &&
               resource.data.participants != null && 
               resource.data.participants is list &&
               resource.data.participants.size() > 0 &&
               (request.auth.uid == resource.data.participants[0] ||
                (resource.data.participants.size() > 1 && request.auth.uid == resource.data.participants[1]));
      }
      
      // Helper to safely check if user is admin
      function safeIsAdmin() {
        return isAuthenticated() && 
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Allow read if user is participant or admin
      allow read: if isAuthenticated() && (userIsParticipant() || safeIsAdmin());
      
      // Allow create if authenticated and user is in participants array
      allow create: if isAuthenticated() && 
                     request.resource.data.participants != null &&
                     request.resource.data.participants is list &&
                     request.resource.data.participants.size() > 0 &&
                     (request.auth.uid == request.resource.data.participants[0] || 
                      (request.resource.data.participants.size() > 1 && request.auth.uid == request.resource.data.participants[1]));
      
      // Allow update if user is participant or admin
      allow update: if isAuthenticated() && (userIsParticipant() || safeIsAdmin());
      
      // Only admins can delete chats
      allow delete: if safeIsAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        // Get chat document to check participants
        function getChatParticipants() {
          return get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        }
        
        // Helper to check if user is participant in parent chat
        function userIsChatParticipant() {
          let participants = getChatParticipants();
          return participants != null && 
                 participants is list &&
                 participants.size() > 0 &&
                 (request.auth.uid == participants[0] || 
                  (participants.size() > 1 && request.auth.uid == participants[1]));
        }
        
        // Helper to safely check if user is admin
        function safeIsAdminForMessages() {
          return isAuthenticated() && 
                 exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Allow read (both get and list) if user is participant in the parent chat OR admin
        allow read: if isAuthenticated() && (userIsChatParticipant() || safeIsAdminForMessages());
        
        // Allow create if user is participant or admin
        allow create: if isAuthenticated() && (userIsChatParticipant() || safeIsAdminForMessages());
        
        // Allow update only for seen/seenAt fields (for read receipts)
        // User must be a participant and can only mark messages from others as seen
        allow update: if isAuthenticated() && 
                      userIsChatParticipant() &&
                      resource.data.senderId != request.auth.uid &&
                      // Ensure critical fields haven't changed
                      request.resource.data.senderId == resource.data.senderId &&
                      request.resource.data.text == resource.data.text &&
                      request.resource.data.timestamp == resource.data.timestamp &&
                      // Only allow updating seen to true and adding seenAt
                      request.resource.data.seen == true;
        
        // Messages cannot be deleted
        allow delete: if false;
      }
    }
    
    // Favorites collection
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated();
    }
    
    // Complaints collection
    match /complaints/{complaintId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Ratings collection
    match /ratings/{ratingId} {
      allow read: if true; // Public read for ratings
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
